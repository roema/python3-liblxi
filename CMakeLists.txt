cmake_minimum_required(VERSION 3.10)

Project(python3-liblxi)
set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} "${CMAKE_SOURCE_DIR}")

# this figures out the Python include directories and adds them to the
# header file search path
execute_process(
    COMMAND python3-config --includes
    COMMAND sed -r "s/-I//g; s/ +/;/g"
    COMMAND tr -d '\n'
    OUTPUT_VARIABLE Python_Includes
)
include_directories(${Python_Includes})

find_package(Boost REQUIRED COMPONENTS system python)
if(Boost_FOUND)
    include_directories(${Boost_INCLUDE_DIRS})
    MESSAGE(STATUS "Boost_LIB_VERSION: " ${Boost_LIB_VERSION})
    MESSAGE(STATUS "Boost_INCLUDE_DIRS are: " ${Boost_INCLUDE_DIRS})
    MESSAGE(STATUS "Boost_PYTHON_LIBRARY is: " ${Boost_PYTHON_LIBRARY})
    MESSAGE(STATUS "boost_LIBRARY_DIRS is: " ${Boost_LIBRARY_DIRS})
    MESSAGE(STATUS "Boost_LIBRARIES is: " ${Boost_LIBRARIES})    
endif()

find_package(LibXml2 REQUIRED)
if( LIBXML2_FOUND )
   MESSAGE(STATUS "libmxml2_LIBRARY is: " ${LIBXML2_LIBRARIES})
   MESSAGE(STATUS "libxml2_INCLUDE_DIRS is: " ${LIBXML2_INCLUDE_DIR})
endif()

find_package(Libavahi REQUIRED)
if( LIBAVAHI_COMMON )
   MESSAGE(STATUS "libavahi-common is: " ${LIBAVAHI_COMMON})
   MESSAGE(STATUS "libavahi-client is: " ${LIBAVAHI_CLIENT})
endif ( LIBAVAHI_COMMON )

find_package(RpcGen REQUIRED)
if(RPCGEN_FOUND)
  MESSAGE(STATUS "rpcgen executable: " ${RPCGEN_EXECUTABLE})

endif(RPCGEN_FOUND)

# these generated by rpcgen
# outputs: vxi11core_clnt.c vxi11core_xdr.c include/vxi11core.h:
# command: rpcgen -M vxi11core.rpcl
# mv vxi11core.h include
add_custom_command(
  OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/liblxi/src/vxi11core_clnt.c
  OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/liblxi/src/vxi11core_xdr.c
  OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/liblxi/src/vxi11core.h
  COMMAND ${RPCGEN_EXECUTABLE} -M ${CMAKE_CURRENT_SOURCE_DIR}/liblxi/src/vxi11core.rpcl
)


set(LXI_SRC_FILES
    liblxi/src/lxi.c
    liblxi/src/vxi11.c
    liblxi/src/tcp.c
    liblxi/src/mdns.c
    liblxi/src/avahi.c
    ${CMAKE_CURRENT_SOURCE_DIR}/liblxi/src/vxi11core_clnt.c # generated
    ${CMAKE_CURRENT_SOURCE_DIR}/liblxi/src/vxi11core_xdr.c  # generated
    pylxi.cpp
)

set(LXI_INCLUDE_FILES
    liblxi/src/include/lxi.h
    liblxi/src/include/session.h
    liblxi/src/include/vxi11.h
    liblxi/src/include/tcp.h
    liblxi/src/include/error.h
    liblxi/src/include/mdns.h
    liblxi/src/vxi11core.h # generated (rpcgen)
    liblxi/src/include/config.h # generated (autogen, configure)
    liblxi/src/include/avahi.h
)

# python library, aka module
add_library(
    lxi
    MODULE
    ${LXI_SRC_FILES}
    ${LXI_INCLUDE_FILES}
)
target_include_directories(lxi PRIVATE liblxi/src/include)
target_include_directories(lxi PRIVATE liblxi/src)
target_include_directories(lxi PUBLIC SYSTEM ${LIBXML2_INCLUDE_DIR})
target_link_libraries(lxi ${LIBXML2_LIBRARIES})
target_link_libraries(lxi ${LIBAVAHI_COMMON})
target_link_libraries(lxi ${LIBAVAHI_CLIENT})
target_link_libraries(lxi ${Boost_LIBRARIES})

# figure out where to install python library
execute_process(
    #COMMAND python -c "from distutils.sysconfig import get_python_lib; print get_python_lib(0,0,\"/usr/local\")"
	COMMAND echo "/usr/local/lib/python3.8/dist-packages"
    OUTPUT_VARIABLE Python_site_packages
    OUTPUT_STRIP_TRAILING_WHITESPACE
)
MESSAGE(STATUS "Python module will be installed to: " ${Python_site_packages}) 

# python library install target
install(
  TARGETS lxi
  LIBRARY
  DESTINATION ${Python_site_packages}
)

